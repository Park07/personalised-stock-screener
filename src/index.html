<!DOCTYPE html>
<html>
<head>
    <title>Investment Analyst Chat</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        #chat-container { border: 1px solid #ccc; height: 400px; overflow-y: auto; padding: 10px; margin-bottom: 10px; }
        .user-message { background-color: #dcf8c6; padding: 8px; border-radius: 5px; margin: 5px 0; }
        .assistant-message { background-color: #f1f0f0; padding: 8px; border-radius: 5px; margin: 5px 0; }
        #message-form { display: flex; }
        #message-input { flex-grow: 1; padding: 8px; }
        button { padding: 8px 16px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Investment Analyst Chat</h1>
    
    <div id="company-selection">
        <label for="company-input">Company Name:</label>
        <input type="text" id="company-input" placeholder="e.g., Tesla">
        <button id="start-chat">Start Chat</button>
    </div>
    
    <div id="chat-section" style="display:none;">
        <div id="chat-container"></div>
        <form id="message-form">
            <input type="text" id="message-input" placeholder="Ask about the company...">
            <button type="submit">Send</button>
        </form>
        <button id="generate-report">Generate Investment Report</button>
    </div>
    
    <script>
        let sessionId = null;
        let companyName = '';
        
        document.getElementById('start-chat').addEventListener('click', function() {
            companyName = document.getElementById('company-input').value.trim();
            if (!companyName) {
                alert('Please enter a company name');
                return;
            }
            
            document.getElementById('company-selection').style.display = 'none';
            document.getElementById('chat-section').style.display = 'block';
            
            // Add initial system message
            addMessage('assistant', `Let's discuss ${companyName}. What would you like to know?`);
        });
        
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            addMessage('user', message);
            messageInput.value = '';
            
            // Send message to backend
            fetch('/v1/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message,
                    company_name: companyName
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`);
                    return;
                }
                
                sessionId = data.session_id;
                addMessage('assistant', data.response);
            })
            .catch(error => {
                addMessage('assistant', `Error: ${error.message}`);
            });
        });
        
        document.getElementById('generate-report').addEventListener('click', function() {
            addMessage('user', `Generate an investment report for ${companyName}`);
            
            fetch(`/v1/analysis/report?company_name=${encodeURIComponent(companyName)}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    chat_history: sessionId ? getSessionHistory() : []
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    addMessage('assistant', `Error: ${data.error}`);
                    return;
                }
                
                const report = formatReport(data);
                addMessage('assistant', report);
            })
            .catch(error => {
                addMessage('assistant', `Error: ${error.message}`);
            });
        });
        
        function addMessage(role, content) {
            const chatContainer = document.getElementById('chat-container');
            const messageDiv = document.createElement('div');
            messageDiv.className = role === 'user' ? 'user-message' : 'assistant-message';
            messageDiv.textContent = content;
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        function getSessionHistory() {
            // In a real app, you would retrieve this from your session storage
            return []; // Placeholder
        }
        
        function formatReport(data) {
            let report = `Investment Report for ${companyName}\n\n`;
            
            if (data.bravo_analysis) {
                report += `Analysis: ${data.bravo_analysis}\n\n`;
            }
            
            if (data.sentiment_analysis) {
                const sentiment = data.sentiment_analysis;
                report += `Sentiment Analysis:\n`;
                report += `- Total events analyzed: ${sentiment.total_events}\n`;
                report += `- Positive: ${sentiment.positive_percentage.toFixed(1)}%\n`;
                report += `- Neutral: ${sentiment.neutral_percentage.toFixed(1)}%\n`;
                report += `- Negative: ${sentiment.negative_percentage.toFixed(1)}%\n\n`;
            }
            
            if (data.financial_data) {
                const finance = data.financial_data;
                report += `Financial Data:\n`;
                report += `- Ticker: ${finance.ticker}\n`;
                report += `- Current Price: $${finance.current_price}\n`;
                report += `- Market Cap: $${(finance.market_cap/1000000000).toFixed(2)} billion\n`;
                report += `- 52-Week Range: $${finance.52_week_low} - $${finance.52_week_high}\n`;
                if (finance.pe_ratio) report += `- P/E Ratio: ${finance.pe_ratio.toFixed(2)}\n`;
                if (finance.dividend_yield) report += `- Dividend Yield: ${(finance.dividend_yield*100).toFixed(2)}%\n`;
            }
            
            return report;
        }
    </script>
</body>
</html>