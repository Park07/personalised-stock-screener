name: Lint and Test Python Code

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirement.txt
        pip install flask
        pip install pylint

    - name: Run pylint and save output
      run: |
        mkdir -p reports
        pylint --disable="C0114,C0115,C0116,W0718,E0401,E0606,E0611,W0401,R1710,C0103,E0602,R0914,C0103,W0611,R1732,W1309,C0104,W0622,W3101,R0801,E1101,W0621,R1702,R0913,R0917,W0631,R0912,R0915,W0612,R0911,R0914,C0411,E0001,C0105,W1203,C0301,R1705,C0415,W1201,C0321,W0603,W0105,E0102,R1735,R1721,W0702,W0106,W0311,C0206,C0303,C0304,W0511,W0640.C0412" . > reports/pylint_output.txt || true

    - name: Upload pylint artifact
      uses: actions/upload-artifact@v4
      with:
        name: pylint-report
        path: reports/pylint_output.txt

    - name: Run pylint
      run: |
        pylint --disable="C0114,C0115,C0116,W0718,E0401,E0606,E0611,W0401,R1710,C0103,E0602,R0914,C0103,W0611,R1732,W1309,C0104,W0622,W3101,R0801,E1101,W0621,R1702,R0913,R0917,W0631,R0912,R0915,W0612,R0911,R0914,C0411,E0001,C0105,W1203,C0301,R1705,C0415,W1201,C0321,W0603,W0105,E0102,R1735,R1721,W0702,W0106,W0311,C0206,C0303,C0304,W0511,W0640,C0412" .

  test:
    runs-on: ubuntu-latest
    needs: lint

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirement.txt
        pip install flask
        pip install pytest

    - name: Run pytest and save output
      run: |
        mkdir -p reports
        pytest | tee reports/pytest_output.txt

    - name: Upload pytest artifact
      uses: actions/upload-artifact@v4
      with:
        name: pytest-report
        path: reports/pytest_output.txt

    - name: Run pytest
      run: |
        pytest
